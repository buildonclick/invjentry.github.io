<!DOCTYPE html>
<html>
<head>
    <title>Nearby Places Finder - Debug Version</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            max-width: 800px;
            margin: 0 auto;
        }
        h1 { 
            color: #333; 
            text-align: center;
        }
        #location-info, #status, #debug, #results {
            margin: 15px 0;
            padding: 15px;
            border-radius: 6px;
        }
        #location-info { background: #e8f4fd; border-left: 4px solid #4285f4; }
        #status { background: #fff; }
        #debug { background: #f8f9fa; border: 1px solid #ddd; font-family: monospace; }
        #results { background: #fff; }
        .place {
            padding: 10px;
            border-bottom: 1px solid #eee;
            margin: 10px 0;
        }
        button {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        button:disabled { background-color: #a0c3ff; cursor: not-allowed; }
        .error { color: #d93025; background: #fce8e6; padding: 10px; border-radius: 4px; }
        .success { color: #137333; background: #e6f4ea; padding: 10px; border-radius: 4px; }
        .warning { color: #f9ab00; background: #fff8e1; padding: 10px; border-radius: 4px; }
        .loading { color: #666; text-align: center; padding: 20px; }
    </style>
</head>
<body>

<h1>üîç Nearby Places Finder - Debug Mode</h1>

<button id="search-btn" onclick="getLocationAndSearch()">Find Nearby Restaurants</button>

<div id="location-info">
    <strong>Location Status:</strong> Waiting for user action...
</div>

<div id="status">
    <strong>API Status:</strong> Not started
</div>

<div id="debug">
    <strong>Debug Log:</strong><br>
    Page loaded successfully. Click the button to start.
</div>

<div id="results">
    <strong>Results:</strong> Will appear here after search
</div>

<script>
let googleLoaded = false;
let userLocation = null;

// Debug logging function
function debugLog(message, type = 'info') {
    const debugDiv = document.getElementById('debug');
    const timestamp = new Date().toLocaleTimeString();
    const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
    debugDiv.innerHTML += `${icon} [${timestamp}] ${message}<br>`;
    debugDiv.scrollTop = debugDiv.scrollHeight;
    console.log(`[${type.toUpperCase()}] ${message}`);
}

// Check if Google Maps API loaded
function checkGoogleLoaded() {
    if (window.google && window.google.maps) {
        googleLoaded = true;
        debugLog('Google Maps API detected as loaded', 'success');
        return true;
    }
    return false;
}

// Initialize with fallback
function initializeApp() {
    debugLog('Initializing application...');
    
    // Check if Google loaded every second for 10 seconds
    let checkCount = 0;
    const checkInterval = setInterval(() => {
        checkCount++;
        if (checkGoogleLoaded()) {
            clearInterval(checkInterval);
            initializeMap();
        } else if (checkCount >= 10) {
            clearInterval(checkInterval);
            debugLog('Google Maps API failed to load after 10 seconds', 'error');
            document.getElementById('status').innerHTML = '<div class="error">‚ùå Google Maps API failed to load. The API key may be invalid or missing required permissions.</div>';
        }
    }, 1000);
}

function initializeMap() {
    try {
        debugLog('Initializing Google Maps service...');
        
        // Create minimal hidden map
        const mapElement = document.createElement('div');
        mapElement.style.display = 'none';
        document.body.appendChild(mapElement);
        
        const map = new google.maps.Map(mapElement, {
            center: { lat: 0, lng: 0 },
            zoom: 2
        });

        window.placesService = new google.maps.places.PlacesService(map);
        debugLog('Google Places service initialized successfully', 'success');
        document.getElementById('status').innerHTML = '<div class="success">‚úÖ Google Places API ready</div>';
        
    } catch (error) {
        debugLog(`Failed to initialize map: ${error.message}`, 'error');
        document.getElementById('status').innerHTML = `<div class="error">‚ùå Map initialization failed: ${error.message}</div>`;
    }
}

function getLocationAndSearch() {
    const searchBtn = document.getElementById('search-btn');
    searchBtn.disabled = true;
    searchBtn.textContent = "Finding Location...";
    
    debugLog('Starting location detection...');
    document.getElementById('results').innerHTML = '<div class="loading">üîÑ Finding your location...</div>';

    if (!navigator.geolocation) {
        debugLog('Geolocation API not supported by browser', 'error');
        document.getElementById('status').innerHTML = '<div class="error">‚ùå Geolocation not supported by your browser</div>';
        searchBtn.disabled = false;
        searchBtn.textContent = "Find Nearby Restaurants";
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (position) => {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            
            document.getElementById('location-info').innerHTML = 
                `<strong>üìç Your Location:</strong><br>
                 Latitude: ${userLocation.lat.toFixed(6)}<br>
                 Longitude: ${userLocation.lng.toFixed(6)}`;
            
            debugLog(`Location obtained: ${userLocation.lat}, ${userLocation.lng}`, 'success');
            searchNearbyPlaces();
        },
        (error) => {
            let errorMsg = "Location Error: ";
            switch(error.code) {
                case 1: errorMsg += "Permission denied"; break;
                case 2: errorMsg += "Position unavailable"; break;
                case 3: errorMsg += "Timeout"; break;
                default: errorMsg += "Unknown error";
            }
            
            debugLog(errorMsg, 'error');
            document.getElementById('status').innerHTML = `<div class="error">‚ùå ${errorMsg}</div>`;
            document.getElementById('results').innerHTML = `<div class="error">${errorMsg}. Please allow location access and try again.</div>`;
            
            searchBtn.disabled = false;
            searchBtn.textContent = "Find Nearby Restaurants";
            
            // Fallback: Use a default location (New York)
            debugLog('Using fallback location (New York)', 'warning');
            userLocation = { lat: 40.7128, lng: -74.0060 };
            document.getElementById('location-info').innerHTML = 
                `<strong>üìç Using Default Location (New York):</strong><br>
                 Latitude: ${userLocation.lat.toFixed(6)}<br>
                 Longitude: ${userLocation.lng.toFixed(6)}`;
            searchNearbyPlaces();
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        }
    );
}

function searchNearbyPlaces() {
    const searchBtn = document.getElementById('search-btn');
    searchBtn.textContent = "Searching Restaurants...";
    
    debugLog('Starting Places API search...');
    document.getElementById('results').innerHTML = '<div class="loading">üîç Searching for nearby restaurants...</div>';

    if (!window.placesService) {
        debugLog('Places service not available', 'error');
        document.getElementById('status').innerHTML = '<div class="error">‚ùå Places service not initialized</div>';
        searchBtn.disabled = false;
        searchBtn.textContent = "Find Nearby Restaurants";
        return;
    }

    const request = {
        location: new google.maps.LatLng(userLocation.lat, userLocation.lng),
        radius: 5000, // 5km
        type: ['restaurant']
    };

    debugLog(`Sending request: ${JSON.stringify(request)}`);

    // Add timeout for Places API call
    const apiTimeout = setTimeout(() => {
        debugLog('Places API request timed out (10 seconds)', 'error');
        document.getElementById('status').innerHTML = '<div class="error">‚ùå Places API request timed out</div>';
        document.getElementById('results').innerHTML = '<div class="error">The search timed out. This usually means the API key is invalid or the Places API is not enabled.</div>';
        searchBtn.disabled = false;
        searchBtn.textContent = "Find Nearby Restaurants";
    }, 10000);

    window.placesService.nearbySearch(request, (results, status) => {
        clearTimeout(apiTimeout);
        
        debugLog(`Places API response: ${status}`);
        console.log('Places API Response:', { status, results });

        searchBtn.disabled = false;
        searchBtn.textContent = "Find Nearby Restaurants";

        if (status !== google.maps.places.PlacesServiceStatus.OK) {
            let errorMsg = "Places API Error: ";
            switch(status) {
                case 'ZERO_RESULTS': errorMsg = "No restaurants found nearby"; break;
                case 'INVALID_REQUEST': errorMsg = "Invalid API request - check API key"; break;
                case 'OVER_QUERY_LIMIT': errorMsg = "API quota exceeded"; break;
                case 'REQUEST_DENIED': errorMsg = "API request denied - check if Places API is enabled"; break;
                case 'UNKNOWN_ERROR': errorMsg = "Unknown API error"; break;
                default: errorMsg += status;
            }
            
            debugLog(errorMsg, 'error');
            document.getElementById('status').innerHTML = `<div class="error">‚ùå ${errorMsg}</div>`;
            
            if (status === 'REQUEST_DENIED' || status === 'INVALID_REQUEST') {
                document.getElementById('results').innerHTML = `
                    <div class="error">
                        <strong>API Configuration Issue Detected:</strong><br>
                        1. Go to <a href="https://console.cloud.google.com/" target="_blank">Google Cloud Console</a><br>
                        2. Enable "Places API" and "Maps JavaScript API"<br>
                        3. Ensure billing is set up<br>
                        4. Restrict your API key to these APIs and your domain
                    </div>
                `;
            } else {
                document.getElementById('results').innerHTML = `<div class="error">${errorMsg}</div>`;
            }
            return;
        }

        debugLog(`Success! Found ${results.length} restaurants`, 'success');
        document.getElementById('status').innerHTML = `<div class="success">‚úÖ Found ${results.length} restaurants nearby!</div>`;

        let html = '<div class="success">üéâ Search successful! Found restaurants:</div>';
        if (results.length === 0) {
            html = '<div class="warning">No restaurants found within 5km radius</div>';
        } else {
            results.slice(0, 10).forEach((place, index) => {
                html += `
                    <div class="place">
                        <strong>${index + 1}. ${place.name}</strong><br>
                        ‚≠ê Rating: ${place.rating || 'N/A'}<br>
                        üìç Address: ${place.vicinity || 'Address not available'}<br>
                        üí∞ Price Level: ${'$'.repeat(place.price_level || 1)}
                    </div>
                `;
            });
        }

        document.getElementById('results').innerHTML = html;
    });
}

// Start the application
initializeApp();

// Manual fallback in case Google API fails
setTimeout(() => {
    if (!googleLoaded) {
        debugLog('Google Maps API not detected after page load', 'warning');
        document.getElementById('status').innerHTML = `
            <div class="warning">
                ‚ö†Ô∏è Google Maps API not loaded. Common fixes:<br>
                1. Check API key in Google Cloud Console<br>
                2. Enable Places API and Maps JavaScript API<br>
                3. Add "invjentry.github.io" to allowed domains<br>
                4. Ensure billing is set up
            </div>
        `;
    }
}, 3000);
</script>

<!-- Google Maps API - This is likely where the issue is -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBz8TJrPNKb7lzxwLC4P6C6vWl7Ut3akOY&libraries=places&callback=checkGoogleLoaded" async defer></script>

</body>
</html>
